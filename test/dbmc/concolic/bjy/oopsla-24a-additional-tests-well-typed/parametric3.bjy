# Continuation monad -- improper use of bind

# Currently has no intended error because there is a bug in the dependent types
# TODO: figure out bug

let t r a = {: continuation : (a -> r) -> r :}
in

let bind (ar_r : t ('r) ('a)) : ('a -> t ('r) ('b)) -> t ('r) ('b) =
  fun a_br_r ->
    { continuation = 
      fun br -> ar_r.continuation (fun a -> (a_br_r a).continuation br)
    }
in

let r = {: r : int :}
in

let x =
  { continuation =
    fun ir ->
      { r = (ir 0).r + 1 } }
in

let f =
  fun i ->
    { continuation =
      fun lir ->
        lir [ i ]
    }
in

let y = bind x f
in

let z = y.continuation (fun ls ->
  match ls with
  | [] -> { b = 0 }
  | hd :: tl -> { b = hd }
  end
)
in

z
