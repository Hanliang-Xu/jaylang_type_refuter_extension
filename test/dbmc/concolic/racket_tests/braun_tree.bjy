# error is that item is always inserted on the left, so it doesn't stay balanced
# the concolic evaluator doesn't find this error, probably because the union type is expensive

let t = Mu tt. (``Node {: v : 'a , l : tt , r : tt :} || ``Leaf {: leaf : bool :}) in

let rec size n = 
  match n with
  | `Leaf leaf -> 0
  | `Node node -> 1 + size node.l + size node.r
  end
in

let rec is_braun_tree x = 
  match x with
  | `Leaf leaf -> true
  | `Node ->
    let l = node.l in
    let r = node.r in
    is_braun_tree l
    and is_braun_tree r
    and (size l == size r or size l == size r + 1)
  end
in

let bt = {. t | is_braun_tree } in

let rec insert (tree : bt) (x : 'a) : bt =
  match tree with
  | `Leaf leaf -> `Node { v = x , l = `Leaf { leaf = true } , r = `Leaf { leaf = true } }
  | `Node node -> `Node { l = insert node.l x , r = node.r , v = node.v }
  end
in

insert